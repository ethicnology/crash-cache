# =============================================================================
# CRASH-CACHE CONFIGURATION
# =============================================================================
#
# All values below are set to MEDIUM profile defaults (5-20k users, 8GB RAM, 4 CPU).
# Adjust based on your workload:
#
#   SMALL:  1-5k users,  2GB RAM, 1 CPU
#   MEDIUM: 5-20k users, 8GB RAM, 4 CPU
#   LARGE:  20k+ users,  16GB RAM, 8+ CPU
#
# =============================================================================

# =============================================================================
# DOCKER COMPOSE
# =============================================================================
# These variables are only used by docker-compose.yml.
# If you run the binary directly (native build), ignore this section.

# PostgreSQL superuser password (used to create the crash_cache database)
POSTGRES_PASSWORD=changeme

# Password shared by Metabase users (metabase_app and metabase_readonly)
METABASE_PASSWORD=changeme_metabase

# Metabase dashboard host port (Docker Compose only, Metabase always listens on 3000 internally)
METABASE_PORT=3001

# =============================================================================
# DATABASE
# =============================================================================
# PostgreSQL connection string
# Docker Compose users: this is auto-generated from POSTGRES_PASSWORD, no need to change it
# Native build users:   set this to your PostgreSQL connection string
DATABASE_URL=postgresql://crash_cache:changeme@localhost:5432/crash_cache

# Connection pool size (concurrent database connections)
#   SMALL: 10-15  |  MEDIUM: 30-40  |  LARGE: 80-100
DATABASE_POOL_SIZE=30

# Connection acquire timeout in seconds (returns HTTP 503 if exceeded)
#   SMALL: 30  |  MEDIUM: 20  |  LARGE: 15
DATABASE_POOL_TIMEOUT_SECS=20

# =============================================================================
# HTTP SERVER
# =============================================================================
# Address and port the crash-cache binary listens on
# In Docker Compose, this also controls the host port mapping
CRASH_CACHE_HOST=0.0.0.0
CRASH_CACHE_PORT=3000

# Maximum accepted payload sizes
# Supports math expressions: "50 * 1024" = 51200 bytes (50 KB)
#
# Compressed   = gzip-encoded body received from Sentry SDKs
# Uncompressed = raw JSON after decompression
#
# Real-world data: avg compressed ~4 KB, max ~22 KB | avg uncompressed ~16 KB, max ~105 KB
MAX_COMPRESSED_PAYLOAD_BYTES="50 * 1024"
MAX_UNCOMPRESSED_PAYLOAD_BYTES="200 * 1024"

# =============================================================================
# BACKGROUND WORKER
# =============================================================================
# The worker dequeues raw archives, decompresses, parses, and creates reports/issues.

# How often the worker runs (seconds). Also controls cache TTL for health stats.
#   SMALL: 60  |  MEDIUM: 60  |  LARGE: 30
WORKER_INTERVAL_SECS=60

# Max queued archives to process per cycle
#   SMALL: 50  |  MEDIUM: 100  |  LARGE: 200
WORKER_REPORTS_BATCH_SIZE=100

# =============================================================================
# CONCURRENCY
# =============================================================================
# Max parallel gzip compression operations (CPU-intensive)
# Rule of thumb: 2-3× your CPU cores
#   SMALL: 4  |  MEDIUM: 8-12  |  LARGE: 16-24
MAX_CONCURRENT_COMPRESSIONS=12

# =============================================================================
# RATE LIMITING
# =============================================================================
# All values are requests per second. Set to 0 to disable.
# When exceeded, clients receive HTTP 429.

# Total requests/sec across all clients
#   SMALL: 300  |  MEDIUM: 800  |  LARGE: 2000
RATE_LIMIT_REQUESTS_PER_SEC=800

# Requests/sec from a single IP address
#   SMALL: 20  |  MEDIUM: 30  |  LARGE: 50
RATE_LIMIT_PER_IP_PER_SEC=30

# Requests/sec for a single project
#   SMALL: 150  |  MEDIUM: 500  |  LARGE: 1000
RATE_LIMIT_PER_PROJECT_PER_SEC=500

# Burst multiplier (e.g. 2 = allow short bursts at 2× the limit)
RATE_LIMIT_BURST_MULTIPLIER=2

# =============================================================================
# ANALYTICS
# =============================================================================
# Flush interval: how often aggregated metrics are written to the database (seconds)
ANALYTICS_FLUSH_INTERVAL_SECS=10

# Retention: analytics data older than this is automatically deleted (days)
ANALYTICS_RETENTION_DAYS=30

# Internal buffer size for the metrics channel
# Formula: max_RPS × flush_interval × 2
#   SMALL: 10000  |  MEDIUM: 20000  |  LARGE: 50000
ANALYTICS_BUFFER_SIZE=20000
